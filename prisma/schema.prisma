// Prisma Schema for CUHK Course Selection System
// This schema includes comprehensive models for handling concurrent course enrollment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// USER MODEL
// ============================================================================

model User {
  id             Int          @id @default(autoincrement())
  userIdentifier String       @unique @map("user_identifier")
  email          String       @unique
  passwordHash   String       @map("password_hash")
  fullName       String       @map("full_name")
  role           Role         @default(STUDENT)
  major          String?
  yearLevel      Int?         @map("year_level")
  department     String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  enrollments    Enrollment[]
  taughtCourses  Course[]     @relation("InstructorCourses")
  auditLogs      AuditLog[]
  shoppingCart   ShoppingCart[]

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([userIdentifier])
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMINISTRATOR
}

// ============================================================================
// COURSE MODEL
// ============================================================================

model Course {
  id                Int           @id @default(autoincrement())
  courseCode        String        @unique @map("course_code")
  courseName        String        @map("course_name")
  department        String
  credits           Int
  maxCapacity       Int           @map("max_capacity")
  currentEnrollment Int           @default(0) @map("current_enrollment")
  description       String?       @db.Text
  prerequisites     String?       @db.Text
  semester          Semester
  year              Int
  status            CourseStatus  @default(ACTIVE)
  instructorId      Int?          @map("instructor_id")
  termId            Int?          @map("term_id")
  version           Int           @default(0) // For optimistic locking
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  instructor        User?         @relation("InstructorCourses", fields: [instructorId], references: [id])
  term              Term?         @relation(fields: [termId], references: [id])
  timeSlots         TimeSlot[]
  enrollments       Enrollment[]
  shoppingCarts     ShoppingCart[]

  @@map("courses")
  @@index([courseCode])
  @@index([department])
  @@index([semester, year])
  @@index([status])
  @@index([instructorId])
  @@index([termId])
}

enum Semester {
  FALL
  SPRING
  SUMMER
}

enum CourseStatus {
  ACTIVE
  INACTIVE
  FULL
}

// ============================================================================
// TIME SLOT MODEL
// ============================================================================

model TimeSlot {
  id        Int       @id @default(autoincrement())
  courseId  Int       @map("course_id")
  dayOfWeek DayOfWeek @map("day_of_week")
  startTime String    @map("start_time") // Format: "09:00"
  endTime   String    @map("end_time")   // Format: "10:30"
  location  String?

  // Relations
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("time_slots")
  @@index([courseId])
  @@index([dayOfWeek])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// ============================================================================
// ENROLLMENT MODEL
// ============================================================================

model Enrollment {
  id               Int              @id @default(autoincrement())
  userId           Int              @map("user_id")
  courseId         Int              @map("course_id")
  termId           Int?             @map("term_id")
  status           EnrollmentStatus @default(PENDING)
  waitlistPosition Int?             @map("waitlist_position")
  grade            String?
  enrolledAt       DateTime         @default(now()) @map("enrolled_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  term             Term?            @relation(fields: [termId], references: [id])

  @@unique([userId, courseId])
  @@map("enrollments")
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@index([termId])
}

enum EnrollmentStatus {
  PENDING
  CONFIRMED
  WAITLISTED
  DROPPED
  REJECTED
}

// ============================================================================
// TERM MODEL
// ============================================================================

model Term {
  id              Int          @id @default(autoincrement())
  name            String       // "2024-25 Term 2"
  code            String       @unique // "2024-25-T2"
  type            TermType     // FALL, SPRING, SUMMER
  status          TermStatus   // UPCOMING, ENROLLMENT, ACTIVE, COMPLETED
  academicYear    String       @map("academic_year") // "2024-25"
  enrollmentStart DateTime     @map("enrollment_start")
  enrollmentEnd   DateTime     @map("enrollment_end")
  termStart       DateTime     @map("term_start")
  termEnd         DateTime     @map("term_end")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  courses         Course[]
  enrollments     Enrollment[]
  shoppingCarts   ShoppingCart[]

  @@map("terms")
  @@index([code])
  @@index([status])
  @@index([type])
}

enum TermType {
  FALL
  SPRING
  SUMMER
}

enum TermStatus {
  UPCOMING
  ENROLLMENT
  ACTIVE
  COMPLETED
}

// ============================================================================
// SHOPPING CART MODEL
// ============================================================================

model ShoppingCart {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  courseId Int      @map("course_id")
  termId   Int      @map("term_id")
  addedAt  DateTime @default(now()) @map("added_at")
  notes    String?  @db.Text

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  term   Term   @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, termId])
  @@map("shopping_cart")
  @@index([userId])
  @@index([termId])
}

// ============================================================================
// AUDIT LOG MODEL
// ============================================================================

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   Int      @map("entity_id")
  changes    Json?
  ipAddress  String?  @map("ip_address")
  timestamp  DateTime @default(now())

  // Relations
  user       User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([entityType, entityId])
}
